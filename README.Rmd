--- 
title: 'Impact of Severe Storm Events' 
author: "Frank Jung" 
date: "10 June 2015" 
output: 
  html_document: 
    toc: yes
---

## Synopsis



## Data Processing

From the [Storm Data](#data) we will obtain casualty and economic damage
measurements. Storm data begins in 1950 and ends in November 2011. 

```{r setoptions, echo=TRUE}
## set our runtime environment and global defaults.
require(knitr)
require(dplyr)
require(stringr)
require(utils)
opts_chunk$set(echo = TRUE, cache = TRUE, fig.width = 10)
```

### Download Storm Data

Download and load [data](#data) which is a `bzip2` archive containing a
storm data `CSV` records.

```{r loadstormdata}
## download archive into local directory
archiveName <- file.path("stormdata.csv.bz2")
if (!file.exists(archiveName)) {
    archiveUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
    download.file(archiveUrl, destfile = archiveName, method = "curl", mode = "wb")
    print(paste(Sys.time(), "archive downloaded"))
}

## load into data frame and convert date column to date
stormdata <- read.csv(archiveName, stringsAsFactors = FALSE)
```

### Subset Storm Data

Subset data for the columns required for analyse of casualties and damages.

```{r subsetcolumns}
## only need a subset of fields from storm data for this analysis
data <- stormdata[, c("EVTYPE", "BGN_DATE", "FATALITIES", "INJURIES",
                      "PROPDMG", "PROPDMGEXP", "CROPDMG", "CROPDMGEXP")]
```

### Tidy Data

Tidy data column names and classes.

```{r tidycolumns}
names(data) <- tolower(names(data))
names(data) <- gsub("_", "", names(data))
data <- transform(data, bgndate = as.Date(bgndate, format= "%m/%d/%Y 0:00:00", tz = "C"))
data <- transform(data, year = strtoi(format(data$bgndate, "%Y")))
data <- transform(data, evtype = toupper(str_trim(evtype)))
```

### Subset Years

By year, how are events distributed? Do we really have little data before 1996?

```{r fulldatahistogram}
## show effect this has
par(mfrow = c(1, 2), mar = c(3, 4, 1, 1), oma = c(2, 1, 1, 0))
hist(data$year, main = "", xlab = "")
## limit to events after 1996
data <- data %>% filter(year >= 1996)
hist(data$year, main = "", ylab = "", xlab = "")
title(main = "Histogram: Event Frequencies by Year", outer = TRUE)
mtext("Year", side = 1, outer = TRUE)
```

So, use data from 1996 onwards as this is when broader range event types were 
recored. See
[http://www.ncdc.noaa.gov/stormevents/details.jsp?type=eventtype](Storm Events
Database: Event Types)

### Casualties

Lets look at the casualties which are made up of `fatalties` and `injuries`:

```{r getcasualties}
casualties <- data %>%
    group_by(evtype) %>%
    summarise(casualty = sum(fatalities + injuries)) %>%
    arrange(desc(casualty))
```

### Economic Damages

Lets cleanup the columns containing the [damages](#damage-exponents).

```{r cleandamages}
## what are the damage exponents?
unique(data$propdmgexp)
unique(data$cropdmgexp)

## convert damage exponents to associated numerics
## see section 2.7 Damage, http://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf
data$propdmgexp <- strtoi(chartr("KMB", "369", data$propdmgexp))
data$cropdmgexp <- strtoi(chartr("KMB", "369", data$cropdmgexp))

## update damage using translated exponents
options(scipen = 20)
data$propdmg <- data$propdmg * 10^data$propdmgexp
data$cropdmg <- data$cropdmg * 10^data$cropdmgexp

## drop old exponent columns
data$propdmgexp <- NULL
data$cropdmgexp <- NULL
```

Summarise the property damage:

```{r getdamages}
damages <- data %>%
    group_by(evtype) %>%
    summarise(damage = sum(propdmg + cropdmg)) %>%
    arrange(desc(damage))
```

### Events

As per NWS Directive 10-1605 there are only 48 valid [event types](#event-types)
as listed in [Table 1, Section 2.1.1 "Storm Data Event Table", National Weather
Service Storm Data Documentation](#documentation) and also [Event Types
Available](http://www.ncdc.noaa.gov/stormevents/details.jsp?type=eventtype)

```{r loadeventtypes}
## load valid event types as per section 2.1.1 "Storm Data Event Table" table 1 on page 6.
## National Weather Service Storm Data Documentation
## See also http://www.ncdc.noaa.gov/stormevents/details.jsp?type=eventtype
## and NWS Directive 10-1605.
eventtypes <- read.csv("eventtypes.csv", stringsAsFactors = FALSE)
eventtypes <- transform(eventtypes, eventtype = toupper(str_trim(eventtype)))
```

How many have we here?

```{r eventtypes}
length(unique(data$evtype))
```

Well, that is way more than the 48 expected. As these are not
verified by NWS we may need to exclude them. For the moment we will continue
processing them and see if they have a material effect on the results.

How do these event types effect casualties?

```{r showbadcasualties}
head(casualties[!(casualties$evtype %in% eventtypes$eventtype), ], 20)
```

How do these event types effect damages?

```{r showbaddamages}
head(damages[!(damages$evtype %in% eventtypes$eventtype), ], 20)
```


Results
=======

What events had the most casualties?
------------------------------------


What events had the greatest economic cost? 
-------------------------------------------


Appendices
==========

Data
----

* [Storm Data](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2)
[47Mb] 

Code
----

* all code and associated documentation is available on GitHub from [here](https://github.com/frankhjung/repdata-project2).

Documentation
-------------

* National Weather Service [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)

* National Climatic Data Center Storm Events
[FAQ](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf)

Storm Data Disclaimer
---------------------

There appears to be multiple sources of data in this data set. As the provenance
can not be guarenteed for these and there appears to be reliable way to identify
them in the data set provided, we will use only records with a known valid
[Event Types](#event-types).

_Some information appearing in Storm Data may be provided by or gathered from
sources outside the National Weather Service (NWS), such as the media, law
enforcement and/or other government agencies, private companies, individuals,
etc. An effort is made to use the best available information, but because of
time and resource constraints, information from these sources may be unverified
by the NWS. Accordingly, the NWS does not guarantee the accuracy or validity of
the information._

Source: Section 1 "Storm Data Disclaimer", [National Weather Service Storm Data 
Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)

Event Types
-----------

Tornado, Thunderstorm Wind and Hail were the only [event
types](http://www.ncdc.noaa.gov/stormevents/details.jsp?type=eventtype) reported
from 1950 to 1995. From 1996, 48 event types were defined by [NWS Directive
10-1605](http://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf). These are
listed in Table 1 of Section 2.1.1 "Storm Data Event Table", [National Weather
Service Storm Data
Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)

They are:

```{r valideventtypes}
print(eventtypes)
```

For convience these have been tabulated into the CSV file, eventtypes.csv 
available here, .

Damage Exponents
----------------

The property and crop damage exponents are documented in Section 2.7 "Damage", 
[National Weather Service Storm Data 
Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)

They are: **K** for thousands ($10^3$), **M** for millions ($10^6$), **B** for
billions ($10^9$)

Session Information
-------------------

This document was produced in RStudio. The session information detailing
packages used is:

```{r sessioninformation} 
sessionInfo()
```
